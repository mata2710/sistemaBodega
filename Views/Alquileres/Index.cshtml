@model SistemaBodega.Models.PagedResult<SistemaBodega.Models.Alquiler>
@using Microsoft.AspNetCore.Http

@{
    ViewData["Title"] = "Alquileres";
    var rol = Context.Session.GetString("Rol");
    var q = ViewBag.q as string ?? string.Empty;

    int totalPages = Math.Max(1, (int)Math.Ceiling((decimal)Model.TotalItems / Model.PageSize));
    int startRow = Model.TotalItems == 0 ? 0 : ((Model.Page - 1) * Model.PageSize) + 1;
    int endRow = Math.Min(Model.Page * Model.PageSize, Model.TotalItems);

    // ✅ Cambiamos la semántica: si llega activos=false => ver inactivos
    bool verInactivos = string.Equals(Context?.Request?.Query["activos"], "false", StringComparison.OrdinalIgnoreCase);
    bool chkRenov = string.Equals(Context?.Request?.Query["renovacion"], "true", StringComparison.OrdinalIgnoreCase);
}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" />

<style>
    .btn-icon {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 36px;
        height: 36px;
        border-radius: 8px;
        text-decoration: none;
        border: none;
        margin-left: .25rem;
        cursor: pointer;
    }

        .btn-icon i {
            font-size: 1.05rem;
            color: #fff;
        }

        .btn-icon.details {
            background: #00809D;
        }

        .btn-icon.edit {
            background: #FFD700;
        }

            .btn-icon.edit i {
                color: #111;
            }

        .btn-icon:hover {
            filter: brightness(.95);
        }

    .table-pro {
        width: 100%;
    }

        .table-pro th, .table-pro td {
            padding: .65rem .8rem;
            vertical-align: middle;
        }

    .td-center {
        text-align: center;
    }

    .td-truncate {
        max-width: 360px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .pager-bar {
        display: flex;
        align-items: center;
        gap: .75rem;
        flex-wrap: wrap;
    }

    .pager-left {
        margin-right: auto;
    }

    .pager-center {
        margin-left: auto;
        margin-right: auto;
    }

    .pager-right {
        margin-left: auto;
    }

    .link-accent {
        color: #00809D;
        text-decoration: none;
    }

        .link-accent:hover {
            color: #00748A;
            text-decoration: underline;
        }

    .page-tools {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: .75rem;
    }

        .page-tools .btn {
            margin-top: 0 !important;
        }

    .card-filters {
        border: 1px solid rgba(0,0,0,.06);
        border-radius: .75rem;
    }

    .search-group {
        position: relative;
    }

        .search-group .btn-search {
            position: absolute;
            right: .5rem;
            top: 50%;
            transform: translateY(-50%);
            width: 36px;
            height: 36px;
            border: 0;
            background: transparent;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

            .search-group .btn-search i {
                color: #00809D;
                font-size: 1.1rem;
            }

            .search-group .btn-search:hover i {
                color: #00748A;
            }

        .search-group .form-control.pe-5 {
            padding-right: 2.5rem !important;
        }

    .badge-ok {
        background: #e6f4f1;
        color: #166f6b;
        padding: .3rem .55rem;
        border-radius: .6rem;
        font-weight: 600;
    }

    .badge-danger {
        background: #fdecea;
        color: #b42318;
        padding: .3rem .55rem;
        border-radius: .6rem;
        font-weight: 600;
    }
</style>

<div class="page-tools mt-3 mb-3">
    <div>
        <h1 class="m-0">Alquileres</h1>
        <div class="text-muted">Total: @Model.TotalItems</div>
    </div>
    <div class="d-flex align-items-center gap-2">
        @if (rol == "Administrador")
        {
            <a asp-action="Create" class="btn btn-primary">
                <i class="bi bi-plus-lg me-1"></i> Crear nuevo alquiler
            </a>
        }
    </div>
</div>

<form method="get" class="card card-filters shadow-sm mb-3">
    <div class="card-body">
        <div class="row g-2 align-items-end">
            <div class="col-md-6">
                <label class="form-label">Buscar</label>
                <div class="search-group">
                    <input type="search" name="q" value="@q" class="form-control pe-5" placeholder="Cliente, bodega, ubicación..." />
                    <button type="submit" class="btn-search" aria-label="Buscar"><i class="bi bi-search"></i></button>
                </div>
            </div>

            <div class="col-md-3">
                <!-- ✅ Switch ahora muestra INACTIVOS cuando está encendido -->
                <div class="form-check form-switch mt-4">
                    <input class="form-check-input"
                           type="checkbox"
                           id="fInactivos"
                           name="activos"
                           value="false"
                           @(ViewBag.VerInactivos == true ? "checked" : "")
                           onchange="this.form.submit()" />
                    <input type="hidden" name="activos" value="true" />
                    <label class="form-check-label" for="fInactivos">Ver inactivos</label>
                </div>

            </div>

            <div class="col-md-3">
                <div class="form-check form-switch mt-4">
                    <input class="form-check-input"
                           type="checkbox"
                           id="fRenov"
                           name="renovacion"
                           value="true"
                           @(chkRenov ? "checked" : null)
                           onchange="this.form.submit()" />
                    <label class="form-check-label" for="fRenov">Renovación automática</label>
                </div>
            </div>
        </div>

        <input type="hidden" name="page" value="1" />
        <input type="hidden" name="pageSize" value="@Model.PageSize" />
    </div>
</form>

<div class="table-wrap">
    <table class="table-pro">
        <thead>
            <tr>
                <th style="width:26%">Cliente</th>
                <th style="width:26%">Bodega</th>
                <th style="width:12%">Inicio</th>
                <th style="width:12%">Fin</th>
                <th style="width:10%">Renov.</th>
                <th style="width:8%">Estado</th>
                <th class="td-center" style="width:16%">Acciones</th>
            </tr>
        </thead>
        <tbody>
            @if (Model?.Items != null && Model.Items.Any())
            {
                foreach (var item in Model.Items)
                {
                    var clienteNombre = item.Cliente?.Nombre ?? "—";
                    var bodegaNombre = item.Bodega?.Nombre ?? "—";

                    <tr>
                        <td class="td-truncate" title="@clienteNombre">
                            <a asp-action="Details" asp-route-id="@item.Id" class="link-accent">@clienteNombre</a>
                        </td>
                        <td class="td-truncate" title="@bodegaNombre">@bodegaNombre</td>
                        <td>@item.FechaInicio.ToString("yyyy-MM-dd")</td>
                        <td>@item.FechaFin.ToString("yyyy-MM-dd")</td>
                        <td class="td-center">
                            @if (item.RenovacionAutomatica)
                            {
                                <span class="badge-ok">Sí</span>
                                ;
                            }
                            else
                            {

                                <span class="badge-danger">No</span>
                                ;
                            }
                        </td>
                        <td class="td-center">
                            @if (item.Activo)
                            {
                                <span class="badge-ok">Activo</span>
                                ;
                            }
                            else
                            {

                                <span class="badge-danger">Inactivo</span>
                                ;
                            }
                        </td>
                        <td class="td-center">
                            <a asp-action="Details" asp-route-id="@item.Id" class="btn-icon details" title="Detalles" aria-label="Detalles"><i class="bi bi-eye"></i></a>
                            @if (rol == "Administrador")
                            {
                                <a asp-action="Edit" asp-route-id="@item.Id" class="btn-icon edit" title="Editar" aria-label="Editar"><i class="bi bi-pencil-square"></i></a>
                                @* Botón de eliminar removido *@
                            }
                        </td>
                    </tr>
                }
            }
            else
            {
                <tr><td colspan="7" class="text-center text-muted py-4">No hay alquileres registrados.</td></tr>
            }
        </tbody>
    </table>
</div>

<nav aria-label="Paginación" class="pager-bar mt-2">
    <div class="small text-muted pager-left">
        Mostrando @startRow – @endRow de @Model.TotalItems
    </div>

    <form method="get" class="d-flex align-items-center gap-2 pager-center">
        <label class="small text-muted mb-0" for="pageSizeSelect">Pág.</label>
        <select id="pageSizeSelect" name="pageSize" class="form-select form-select-sm" onchange="this.form.submit()">
            @{
                var sizes = new[] { 5, 10, 25, 50, 100 };
            }
            @foreach (var s in sizes)
            {
                <option value="@s" selected="@(Model.PageSize == s)">@s</option>
            }
        </select>

        <!-- Preservar búsqueda y filtros y reset a página 1 -->
        <input type="hidden" name="q" value="@q" />
        <input type="hidden" name="page" value="1" />
        @* ✅ Si estamos viendo inactivos, persistimos activos=false *@
        @if (verInactivos)
        {
            <input type="hidden" name="activos" value="false" />
        }
        @if (chkRenov)
        {
            <input type="hidden" name="renovacion" value="true" />
        }
    </form>

    <ul class="pagination mb-0 pager-right">
        <li class="page-item @(Model.Page <= 1 ? "disabled" : "")">
            <a class="page-link"
               asp-action="Index"
               asp-route-page="@(Model.Page - 1)"
               asp-route-pageSize="@Model.PageSize"
               asp-route-q="@q"
               asp-route-activos="@(verInactivos ? "false" : null)"
               asp-route-renovacion="@(chkRenov ? "true" : null)">Anterior</a>
        </li>

        @for (int p = 1; p <= totalPages; p++)
        {
            <li class="page-item @(p == Model.Page ? "active" : "")">
                <a class="page-link"
                   asp-action="Index"
                   asp-route-page="@p"
                   asp-route-pageSize="@Model.PageSize"
                   asp-route-q="@q"
                   asp-route-activos="@(verInactivos ? "false" : null)"
                   asp-route-renovacion="@(chkRenov ? "true" : null)">@p</a>
            </li>
        }

        <li class="page-item @(Model.Page >= totalPages ? "disabled" : "")">
            <a class="page-link"
               asp-action="Index"
               asp-route-page="@(Model.Page + 1)"
               asp-route-pageSize="@Model.PageSize"
               asp-route-q="@q"
               asp-route-activos="@(verInactivos ? "false" : null)"
               asp-route-renovacion="@(chkRenov ? "true" : null)">Siguiente</a>
        </li>
    </ul>
</nav>

