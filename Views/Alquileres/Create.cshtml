@model SistemaBodega.Models.Alquiler

@{
    ViewData["Title"] = "Crear alquiler";

    // Valores iniciales (en Create suelen venir vacíos/por defecto)
    string? clienteNombre = null;
    string? bodegaNombre = null;
    bool renov = Model?.RenovacionAutomatica ?? false;
    bool activo = Model?.Activo ?? true;
}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" />

<style>
    /* ===== Estructura ===== */
    .section-title {
        font-size: 1rem;
        font-weight: 600;
        margin-bottom: .75rem;
        padding-left: .65rem;
        border-left: 4px solid #00809D;
    }

    .card.shadow-sm {
        border: 1px solid rgba(0,0,0,.06);
    }

    .page-tools {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: .75rem;
    }

        .page-tools .btn {
            margin-top: 0 !important;
        }

    /* ===== Botones ===== */
    .btn-save {
        background: #437057 !important;
        color: #fff !important;
        border: 0 !important;
    }

        .btn-save:hover {
            background: #3a614c !important;
            color: #fff !important;
            filter: brightness(.98);
        }

        .btn-save:focus {
            box-shadow: 0 0 0 .2rem rgba(67,112,87,.25) !important;
        }

    .btn-cancel {
        background: #DC3C22 !important;
        color: #fff !important;
        border: 0 !important;
    }

        .btn-cancel:hover {
            background: #C3341E !important;
            color: #fff !important;
        }

        .btn-cancel:focus {
            box-shadow: 0 0 0 .2rem rgba(220,60,34,.25) !important;
        }

    /* ===== Inputs con ícono ===== */
    .input-group-text i {
        opacity: .85;
    }

    /* ===== Grid detalle/preview ===== */
    .dl-grid {
        display: grid;
        grid-template-columns: 160px 1fr;
        row-gap: .35rem;
        column-gap: 1rem;
    }

        .dl-grid dt {
            color: #6c757d;
            font-weight: 600;
            display: flex;
            align-items: center;
        }

        .dl-grid dd {
            margin: 0;
        }
    /* Si activás responsive acá, recordá usar @@media en Razor */
    /* @@media (max-width:768px){ .dl-grid{ grid-template-columns:1fr; } } */

    /* ===== Badge/Pill ===== */
    .badge-pending {
        background: #EAC8A6;
        color: #3d2b12;
        border: 1px solid #EAC8A6;
        padding: .2rem .55rem;
        border-radius: 999px;
        font-weight: 600;
        font-size: .85rem;
    }

    .pill-yes {
        background: #E7F6EC;
        color: #1F7A39;
        border: 1px solid #BDE4C7;
        padding: .2rem .55rem;
        border-radius: 999px;
        font-weight: 600;
        font-size: .85rem;
    }

    .pill-no {
        background: #fdecea;
        color: #b42318;
        border: 1px solid #f5c2c7;
        padding: .2rem .55rem;
        border-radius: 999px;
        font-weight: 600;
        font-size: .85rem;
    }
</style>

<div class="page-tools mt-3 mb-3">
    <h2 class="mb-0">Crear alquiler</h2>
    <a asp-action="Index" class="btn btn-sm btn-outline-secondary">
        <i class="bi bi-arrow-left-short"></i> Volver al listado
    </a>
</div>

<div class="row g-3">
    <!-- Columna izquierda: formulario -->
    <div class="col-lg-8">
        <div class="card shadow-sm">
            <div class="card-body">
                <form asp-action="Create" method="post" enctype="multipart/form-data" novalidate>
                    @Html.AntiForgeryToken()

                    <div asp-validation-summary="ModelOnly"
                         class="alert alert-danger rounded-3 mb-3"
                         role="alert"
                         style="display:@(ViewData.ModelState.IsValid ? "none" : "block")">
                        Revisa los campos marcados en rojo.
                    </div>

                    <div class="mb-3">
                        <label asp-for="ClienteId" class="form-label">Cliente</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-person"></i></span>
                            <select asp-for="ClienteId" class="form-select" asp-items="ViewBag.ClienteId" id="clienteSelect">
                                <option value="">Seleccione...</option>
                            </select>
                        </div>
                        <span asp-validation-for="ClienteId" class="text-danger"></span>
                    </div>

                    <div class="mb-3">
                        <label asp-for="BodegaId" class="form-label">Bodega</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-house-door"></i></span>
                            <select asp-for="BodegaId" class="form-select" asp-items="ViewBag.BodegaId" id="bodegaSelect">
                                <option value="">Seleccione...</option>
                            </select>
                        </div>
                        <span asp-validation-for="BodegaId" class="text-danger"></span>
                    </div>

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label asp-for="FechaInicio" class="form-label"></label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-calendar-event"></i></span>
                                <input asp-for="FechaInicio" class="form-control" type="date" id="inInicio" />
                            </div>
                            <span asp-validation-for="FechaInicio" class="text-danger"></span>
                        </div>
                        <div class="col-md-6">
                            <label asp-for="FechaFin" class="form-label"></label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-calendar2-check"></i></span>
                                <input asp-for="FechaFin" class="form-control" type="date" id="inFin" />
                            </div>
                            <span asp-validation-for="FechaFin" class="text-danger"></span>
                        </div>
                    </div>

                    <!-- Económicos -->
                    <div class="row g-3 mt-1">
                        <div class="col-md-4">
                            <label asp-for="AreaM2" class="form-label">Área (m²)</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-aspect-ratio"></i></span>
                                <input asp-for="AreaM2" class="form-control" id="areaM2" type="number" step="0.01" min="0" />
                            </div>
                            <span asp-validation-for="AreaM2" class="text-danger"></span>
                        </div>
                        <div class="col-md-4">
                            <label asp-for="PrecioPorM2" class="form-label">Precio por m²</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-currency-dollar"></i></span>
                                <input asp-for="PrecioPorM2" class="form-control" id="precioM2" type="number" step="0.01" min="0" />
                            </div>
                            <span asp-validation-for="PrecioPorM2" class="text-danger"></span>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Precio estimado</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-cash-stack"></i></span>
                                <input id="precioPreview" class="form-control" type="text" value="$ 0.00" readonly />
                            </div>
                        </div>
                    </div>

                    <div class="row g-3 mt-1">
                        <div class="col-md-6">
                            <label asp-for="AumentoAnualPorcentaje" class="form-label">Aumento anual (%)</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-graph-up"></i></span>
                                <input asp-for="AumentoAnualPorcentaje" class="form-control" id="inAumento" type="number" step="0.01" min="0" />
                            </div>
                            <span asp-validation-for="AumentoAnualPorcentaje" class="text-danger"></span>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Precio con aumento</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-wallet2"></i></span>
                                <input id="precioConAumento" class="form-control" type="text" value="$ 0.00" readonly />
                            </div>
                        </div>
                    </div>

                    <div class="mb-3 mt-3">
                        <label asp-for="Observaciones" class="form-label"></label>
                        <textarea asp-for="Observaciones" class="form-control" rows="3" placeholder="Observaciones del contrato..."></textarea>
                        <span asp-validation-for="Observaciones" class="text-danger"></span>
                    </div>

                    <!-- Contrato -->
                    <div class="mb-3">
                        <label class="form-label">Contrato (PDF/imagen)</label>
                        <input asp-for="ContratoArchivo" type="file" class="form-control" accept=".pdf,.png,.jpg,.jpeg" />
                        <span asp-validation-for="ContratoArchivo" class="text-danger"></span>
                    </div>

                    <div class="form-check mb-2">
                        <input asp-for="RenovacionAutomatica" class="form-check-input" id="chkRenov" />
                        <label asp-for="RenovacionAutomatica" class="form-check-label"></label>
                    </div>

                    <div class="form-check mb-3">
                        <input asp-for="Activo" class="form-check-input" id="chkActivo" />
                        <label asp-for="Activo" class="form-check-label"></label>
                    </div>

                    <div class="d-flex flex-wrap gap-2 mt-3">
                        <button type="submit" class="btn btn-save">
                            <i class="bi bi-check2"></i> Guardar alquiler
                        </button>
                        <a asp-action="Index" class="btn btn-cancel">
                            <i class="bi bi-x-circle"></i> Cancelar
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Columna derecha: preview en vivo -->
    <div class="col-lg-4">
        <div class="card shadow-sm">
            <div class="card-body">
                <div class="section-title">Resumen (preview)</div>
                <dl class="dl-grid">
                    <dt>Cliente</dt>
                    <dd id="pvCliente">
                        @if (clienteNombre == null)
                        {
                            <span class="badge-pending">Pendiente</span>
                        }
                        else
                        {

                            @clienteNombre
                        }
                    </dd>

                    <dt>Bodega</dt>
                    <dd id="pvBodega">
                        @if (bodegaNombre == null)
                        {
                            <span class="badge-pending">Pendiente</span>
                        }
                        else
                        {

                            @bodegaNombre
                        }
                    </dd>

                    <dt>Inicio</dt>
                    <dd id="pvInicio"><span class="badge-pending">Pendiente</span></dd>

                    <dt>Fin</dt>
                    <dd id="pvFin"><span class="badge-pending">Pendiente</span></dd>

                    <dt>Renovación auto</dt>
                    <dd id="pvRenov">
                        @if (renov)
                        {
                            <span class="pill-yes">Sí</span>
                        }
                        else
                        {

                            <span class="pill-no">No</span>
                        }
                    </dd>

                    <dt>Estado</dt>
                    <dd id="pvActivo">
                        @if (activo)
                        {
                            <span class="pill-yes">Activo</span>
                        }
                        else
                        {

                            <span class="pill-no">Inactivo</span>
                        }
                    </dd>

                    <dt>Área (m²)</dt>
                    <dd id="pvArea"><span class="badge-pending">Pendiente</span></dd>

                    <dt>Precio por m²</dt>
                    <dd id="pvPm2"><span class="badge-pending">Pendiente</span></dd>

                    <dt>Precio estimado</dt>
                    <dd id="pvEst"><span class="badge-pending">Pendiente</span></dd>

                    <dt>Aumento anual</dt>
                    <dd id="pvAum"><span class="badge-pending">Pendiente</span></dd>

                    <dt>Precio con aumento</dt>
                    <dd id="pvEstAum"><span class="badge-pending">Pendiente</span></dd>
                </dl>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script>
        (function(){
            const $cliente = document.getElementById('clienteSelect');
            const $bodega  = document.getElementById('bodegaSelect');
            const $area    = document.getElementById('areaM2');
            const $pm2     = document.getElementById('precioM2');
            const $prev    = document.getElementById('precioPreview');
            const $aum     = document.getElementById('inAumento');
            const $prevAum = document.getElementById('precioConAumento');
            const $ini     = document.getElementById('inInicio');
            const $fin     = document.getElementById('inFin');
            const $chkRen  = document.getElementById('chkRenov');
            const $chkAct  = document.getElementById('chkActivo');

            const pending = '<span class="badge-pending">Pendiente</span>';
            const pillYes = (t) => '<span class="pill-yes">' + (t||'Sí') + '</span>';
            const pillNo  = (t) => '<span class="pill-no">'  + (t||'No') + '</span>';

            function toNumber(v){
                if (typeof v === 'string') v = v.replace(',', '.');
                const n = parseFloat(v);
                return isNaN(n) ? 0 : n;
            }
            function money(n){ return '$ ' + (isFinite(n) ? n.toFixed(2) : '0.00'); }

            function setHtml(id, html){
                const el = document.getElementById(id);
                if (el) el.innerHTML = html;
            }

            function updateCliente(){
                const txt = ($cliente && $cliente.options[$cliente.selectedIndex] ? $cliente.options[$cliente.selectedIndex].text : '').trim();
                setHtml('pvCliente', txt ? txt : pending);
            }
            function updateBodega(){
                const txt = ($bodega && $bodega.options[$bodega.selectedIndex] ? $bodega.options[$bodega.selectedIndex].text : '').trim();
                setHtml('pvBodega', txt ? txt : pending);
            }
            function updateFechas(){
                setHtml('pvInicio', $ini && $ini.value ? $ini.value : pending);
                setHtml('pvFin',    $fin && $fin.value ? $fin.value : pending);
            }
            function updateFlags(){
                setHtml('pvRenov', $chkRen && $chkRen.checked ? pillYes('Sí') : pillNo('No'));
                setHtml('pvActivo', $chkAct && $chkAct.checked ? pillYes('Activo') : pillNo('Inactivo'));
            }
            function updateEconomicos(){
                const a = toNumber($area?.value || 0);
                const p = toNumber($pm2?.value || 0);
                const inc = toNumber($aum?.value || 0);
                const base = a * p;
                const conAum = base * (1 + inc/100);

                if ($prev)    $prev.value    = money(base);
                if ($prevAum) $prevAum.value = money(conAum);

                setHtml('pvArea', a ? a.toFixed(2) : pending);
                setHtml('pvPm2',  p ? money(p) : pending);
                setHtml('pvEst',  base ? money(base) : pending);
                setHtml('pvAum',  (inc || inc === 0) ? (inc.toFixed(2).replace(/\.00$/,'') + ' %') : pending);
                setHtml('pvEstAum', conAum ? money(conAum) : pending);
            }

            // Listeners
            if ($cliente) $cliente.addEventListener('change', updateCliente);
            if ($bodega)  $bodega .addEventListener('change', function(){
                updateBodega();
                const id = this.value;
                if(!id){ if($area) $area.value=''; if($pm2) $pm2.value=''; updateEconomicos(); return; }
                fetch('@Url.Action("GetBodegaData", "Alquileres")?id=' + id)
                    .then(r => r.ok ? r.json() : null)
                    .then(data => {
                        if(!data) return;
                        if($area) $area.value = parseFloat(data.areaM2).toFixed(2);
                        if($pm2)  $pm2.value  = parseFloat(data.precioPorM2).toFixed(2);
                        updateEconomicos();
                    })
                    .catch(() => {});
            });

            [$area, $pm2, $aum].forEach(function(el){
                if (el) el.addEventListener('input', updateEconomicos);
            });
            [$ini, $fin].forEach(function(el){
                if (el) el.addEventListener('change', updateFechas);
            });
            [$chkRen, $chkAct].forEach(function(el){
                if (el) el.addEventListener('change', updateFlags);
            });

            // Inicial
            updateCliente();
            updateBodega();
            updateFechas();
            updateFlags();
            updateEconomicos();
        })();
    </script>
}
