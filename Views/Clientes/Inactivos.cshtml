@model SistemaBodega.Models.PagedResult<SistemaBodega.Models.Cliente>
@using Microsoft.AspNetCore.Http

@{
    ViewData["Title"] = "Clientes Inactivos";
    var rol = Context?.Session?.GetString("Rol");
    var q = ViewBag.q as string ?? string.Empty;

    int totalPages = Math.Max(1, (int)Math.Ceiling((decimal)Model.TotalItems / Model.PageSize));
    int startRow = Model.TotalItems == 0 ? 0 : ((Model.Page - 1) * Model.PageSize) + 1;
    int endRow = Math.Min(Model.Page * Model.PageSize, Model.TotalItems);
}

<style>
    /* Solo lo que NO está en site.css */
    .card-filters {
        border: 1px solid rgba(0,0,0,.06);
        border-radius: .75rem;
    }

    .pager-bar {
        display: flex;
        align-items: center;
        gap: .75rem;
        flex-wrap: wrap;
    }

    .pager-left {
        margin-right: auto;
    }

    .pager-center {
        margin-left: auto;
        margin-right: auto;
    }

    .pager-right {
        margin-left: auto;
    }

    .badge-pending {
        background: #EAC8A6;
        color: #3d2b12;
        border: 1px solid #EAC8A6;
        padding: .2rem .55rem;
        border-radius: 999px;
        font-weight: 600;
        font-size: .85rem;
    }
</style>

<!-- Encabezado -->
<div class="page-tools mt-3 mb-3 justify-content-between">
    <div>
        <h1 class="m-0">Clientes (Inactivos)</h1>
        <div class="text-muted">Total: @Model.TotalItems</div>
    </div>

    <div class="d-flex align-items-center gap-2">
        @* ⚠️ Mantén SIEMPRE este orden: 1) Crear (verde), 2) Volver a Activos (naranja) *@
        @if (rol == "Administrador")
        {
            <a asp-action="Create" class="btn">
                <i class="bi bi-plus-lg me-1"></i> Crear Cliente
            </a>
        }
        <a asp-action="Index" class="btn">
            <i class="bi bi-arrow-left-circle me-1"></i> Volver a Activos
        </a>
    </div>
</div>

@if (TempData["Mensaje"] is string msg && !string.IsNullOrWhiteSpace(msg))
{
    <div class="alert alert-info alert-dismissible fade show" role="alert">
        @msg
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<!-- Filtros -->
<form method="get" class="card card-filters shadow-sm mb-3">
    <div class="card-body">
        <div class="row g-2 align-items-end">
            <div class="col-md-8">
                <label class="form-label">Buscar</label>
                <div class="search-group">
                    <input type="search"
                           name="q"
                           value="@q"
                           class="form-control pe-5"
                           placeholder="Nombre, cédula, email, teléfono..." />
                    <button type="submit" class="btn-search" aria-label="Buscar">
                        <i class="bi bi-search"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Reset a página 1 preservando pageSize -->
        <input type="hidden" name="page" value="1" />
        <input type="hidden" name="pageSize" value="@Model.PageSize" />
    </div>
</form>

<!-- Tabla -->
<div class="table-wrap">
    <table class="table-pro">
        <thead>
            <tr>
                <th style="width:26%">Nombre</th>
                <th class="text-nowrap" style="width:16%">Cédula jurídica</th>
                <th class="text-nowrap" style="width:14%">Teléfono</th>
                <th style="width:18%">Email</th>
                <th class="text-nowrap" style="width:18%">Desactivado</th>
                <th class="td-center" style="width:16%">Acciones</th>
            </tr>
        </thead>
        <tbody>
            @if (Model?.Items != null && Model.Items.Any())
            {
                foreach (var c in Model.Items)
                {
                    var nombre = string.IsNullOrWhiteSpace(c.Nombre) ? null : c.Nombre;
                    var cedula = string.IsNullOrWhiteSpace(c.Identificacion) ? null : c.Identificacion;
                    var tel = string.IsNullOrWhiteSpace(c.Telefono) ? null : c.Telefono;
                    var mail = string.IsNullOrWhiteSpace(c.Email) ? null : c.Email;

                    <tr>
                        <!-- NOMBRE -->
                        <td class="td-truncate" title="@(nombre ?? "Pendiente")">
                            @if (nombre == null)
                            {
                                <span class="badge-pending">Pendiente</span>
                            }
                            else
                            {
                                @if (rol == "Administrador")
                                {
                                    <a asp-action="Edit" asp-route-id="@c.Id">@nombre</a>
                                }
                                else
                                {
                                    @nombre
                                }
                            }
                        </td>

                        <!-- CÉDULA -->
                        <td class="text-nowrap" title="@(cedula ?? "Pendiente")">
                            @if (cedula == null)
                            {
                                <span class="badge-pending">Pendiente</span>
                            }
                            else
                            {

                                @cedula
                            }
                        </td>

                        <!-- TELÉFONO -->
                        <td class="text-nowrap" title="@(tel ?? "Pendiente")">
                            @if (tel == null)
                            {
                                <span class="badge-pending">Pendiente</span>
                            }
                            else
                            {

                                @tel
                            }
                        </td>

                        <!-- EMAIL -->
                        <td title="@(mail ?? "Pendiente")">
                            @if (mail == null)
                            {
                                <span class="badge-pending">Pendiente</span>
                            }
                            else
                            {
                                <a href="mailto:@mail">@mail</a>
                            }
                        </td>

                        <!-- DESACTIVADO -->
                        <td class="text-nowrap">
                            @(c.DeactivatedAt?.ToLocalTime().ToString("g") ?? "-")
                        </td>

                        <!-- ACCIONES -->
                        <td class="td-center">
                            @if (rol == "Administrador")
                            {
                                <div class="d-flex justify-content-center">
                                    <!-- ✏️ Editar -->
                                    <a asp-action="Edit"
                                       asp-route-id="@c.Id"
                                       class="btn-icon edit me-1"
                                       title="Editar"
                                       aria-label="Editar">
                                        <i class="bi bi-pencil-square"></i>
                                    </a>

                                    <!-- ♻️ Reactivar -->
                                    <form asp-action="Activar"
                                          asp-route-id="@c.Id"
                                          method="post"
                                          class="d-inline">
                                        @Html.AntiForgeryToken()
                                        <button type="submit"
                                                class="btn-icon activate"
                                                title="Reactivar"
                                                aria-label="Reactivar">
                                            <i class="bi bi-arrow-counterclockwise"></i>
                                        </button>
                                    </form>
                                </div>
                            }
                        </td>
                    </tr>
                }
            }
            else
            {
                <tr>
                    <td colspan="6" class="text-center text-muted py-4">No se encontraron clientes inactivos.</td>
                </tr>
            }
        </tbody>
    </table>
</div>

<!-- Barra inferior -->
<nav aria-label="Paginación" class="pager-bar mt-2">
    <div class="small text-muted pager-left">
        Mostrando @startRow – @endRow de @Model.TotalItems
    </div>

    <form method="get" class="d-flex align-items-center gap-2 pager-center">
        <label class="small text-muted mb-0" for="pageSizeSelect">Pág.</label>
        <select id="pageSizeSelect" name="pageSize" class="form-select form-select-sm" onchange="this.form.submit()">
            @{
                var sizes = new[] { 5, 10, 25, 50, 100 };
            }
            @foreach (var s in sizes)
            {
                if (Model.PageSize == s)
                {
                    <option value="@s" selected="selected">@s</option>
                }
                else
                {
                    <option value="@s">@s</option>
                }
            }
        </select>
        <!-- preserva búsqueda y reset a página 1 -->
        <input type="hidden" name="q" value="@q" />
        <input type="hidden" name="page" value="1" />
    </form>

    <ul class="pagination mb-0 pager-right">
        <li class="page-item @(Model.Page <= 1 ? "disabled" : "")">
            <a class="page-link"
               asp-action="Inactivos"
               asp-route-page="@(Model.Page - 1)"
               asp-route-pageSize="@Model.PageSize"
               asp-route-q="@q">Anterior</a>
        </li>

        @for (int p = 1; p <= totalPages; p++)
        {
            <li class="page-item @(p == Model.Page ? "active" : "")">
                <a class="page-link"
                   asp-action="Inactivos"
                   asp-route-page="@p"
                   asp-route-pageSize="@Model.PageSize"
                   asp-route-q="@q">@p</a>
            </li>
        }

        <li class="page-item @(Model.Page >= totalPages ? "disabled" : "")">
            <a class="page-link"
               asp-action="Inactivos"
               asp-route-page="@(Model.Page + 1)"
               asp-route-pageSize="@Model.PageSize"
               asp-route-q="@q">Siguiente</a>
        </li>
    </ul>
</nav>
